# 高性能多协议代理池系统 v1.0.0

一个高效的代理池系统，支持HTTP、HTTPS和SOCKS5协议，每次访问刷新端口，每次使用后自动切换代理，确保每次使用都是"新鲜"的代理IP。系统采用LRU（最近最少使用）算法管理代理，并针对高并发场景进行了优化。

## 功能特点

- **多协议支持**：同时支持HTTP、HTTPS和SOCKS5协议
- **单一端口显示**：每次访问只显示一个本地代理端口
- **端口刷新**：每次访问Web服务器刷新一次端口
- **一次性使用**：每个端口在使用后自动切换到新的代理
- **代理转换**：将带验证的远程代理转换为本地无验证代理
- **简单接口**：通过HTTP接口获取代理地址
- **IP不重复**：确保IP地址不重复使用，直到代理池用尽
- **统计信息**：提供代理使用情况的统计信息
- **高并发支持**：优化的锁机制和代理池预热，支持高并发请求
- **大规模代理**：支持使用大量代理(all_proxies.txt)
- **自动跳过无效代理**：系统会自动跳过无效的代理
- **高性能LRU算法**：使用高效的数据结构实现LRU算法

## 系统组件

### 核心模块

- **proxy_core/base/dual_proxy.py**：双协议代理服务器实现
- **proxy_core/pool/lru_proxy_pool.py**：LRU代理池实现
- **proxy_core/pool/lru_manager.py**：LRU管理器
- **proxy_core/web/web_server.py**：代理Web服务器
- **proxy_core/web/request_handlers.py**：HTTP请求处理器

### 辅助模块

- **proxy_core/handlers/**：协议处理器（SOCKS5和HTTP）
- **proxy_core/utils/**：工具函数和日志
- **proxy_server_main.py**：主程序入口

### 测试工具

- **test_proxy_performance.py**：性能测试工具
- **test_proxy.py**：代理功能测试
- **test_api.py**：API接口测试

## 最新优化

系统最近进行了以下优化，大幅提高了并发性能和稳定性：

1. **数据结构优化**：
   - 使用OrderedDict替代列表实现LRU跟踪，提高操作效率
   - 添加代理设置队列，减少锁竞争

2. **锁机制优化**：
   - 使用RLock替代Lock，允许同一线程多次获取锁
   - 增加锁超时时间，从1秒增加到3秒
   - 添加显式锁超时处理和回退机制
   - 减少锁的作用范围，在耗时操作前释放锁

3. **并发处理优化**：
   - 添加工作线程池处理代理设置操作
   - 将耗时操作移出锁保护区域
   - 添加更好的错误处理确保锁总是被释放

4. **错误处理增强**：
   - 添加更健壮的错误处理机制
   - 确保锁在任何情况下都能被释放
   - 添加回退机制确保系统在错误发生时仍能继续运行

5. **性能监控**：
   - 添加性能测试脚本，测量系统在负载下的表现
   - 添加更详细的日志，帮助诊断问题

## 快速开始

### 1. 系统要求

- Python 3.6+
- 依赖包：`requests`

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 配置代理

在`all_proxies.txt`文件中配置远程代理，每行一个代理：

```
IP地址 端口 用户名 密码
```

例如：
```
192.168.1.1 1080 username password
192.168.1.2 1080 username password
```

### 4. 启动服务器

```bash
python proxy_server_main.py --max-active-proxies 100
```

默认情况下，服务器将在`127.0.0.1:7777`上启动，并创建本地代理端口（10000-10099）。

### 5. 使用代理

1. 获取代理地址：
   ```
   http://127.0.0.1:7777
   ```

2. 使用返回的代理地址（例如`127.0.0.1:10000`）进行连接

3. 每次访问Web服务器，都会返回一个新的端口

4. 每次使用后，该端口会自动切换到新的远程代理

### 6. 查看统计信息

```
http://127.0.0.1:7777/stats
```

统计信息包括：
- 代理索引
- 本地端口
- 远程主机和端口
- 用户名
- 最后使用时间
- LRU位置
- 连接次数

## 工作原理

1. **初始化**：系统启动时，会初始化代理池并预热一定数量的代理
2. **请求处理**：当客户端请求代理时，系统返回一个代理地址，并准备下一个端口
3. **端口轮换**：每次访问Web服务器，都会返回一个新的端口
4. **代理切换**：每个端口连接到一个远程代理，使用后会自动切换到一个新的远程代理
5. **LRU管理**：系统使用LRU算法管理代理，确保IP地址不重复使用，直到代理池用尽
6. **并发处理**：系统使用工作线程池和队列处理代理设置操作，提高并发性能
7. **错误处理**：系统会自动跳过无效的代理，并在错误发生时提供回退机制

## 性能测试

系统提供了性能测试工具，可以测试系统在高并发下的表现：

```bash
python test_proxy_performance.py --threads 20 --requests 50
```

这将模拟20个并发客户端，每个客户端发送50个请求，测试系统的并发处理能力。

## 命令行参数

```
python proxy_server_main.py --help
```

可用参数：
- `--host`：Web服务器主机地址（默认：127.0.0.1）
- `--port`：Web服务器端口（默认：7777）
- `--proxy-file`：代理列表文件（默认：all_proxies.txt）
- `--max-active-proxies`：最大活跃代理数量（默认：200，支持高并发）

## 应用场景

- **网络爬虫**：需要频繁切换IP地址的爬虫程序
- **数据采集**：需要避免IP被封禁的数据采集程序
- **API访问**：需要绕过API访问限制的应用
- **匿名访问**：需要匿名访问互联网的应用
- **代理共享**：需要在多个应用程序之间共享代理的场景
- **高并发系统**：需要处理大量并发请求的系统

## 高并发优化建议

对于高并发场景，建议进行以下配置：

1. **增加活跃代理数量**：
   ```bash
   python proxy_server_main.py --max-active-proxies 300
   ```

2. **使用性能测试工具调整参数**：
   ```bash
   python test_proxy_performance.py --threads 50 --requests 100
   ```

3. **监控系统资源使用情况**，确保系统有足够的内存和CPU资源

4. **定期检查日志**，查看是否有锁超时或其他错误

## 故障排除

1. **锁超时问题**：
   - 增加锁超时时间：修改`self.lock_timeout`的值
   - 减少并发请求数量
   - 检查是否有耗时操作在锁保护区域内

2. **代理连接失败**：
   - 检查代理列表是否有效
   - 增加代理连接超时时间
   - 检查网络连接是否正常

3. **内存使用过高**：
   - 减少最大活跃代理数量
   - 定期重启服务以释放资源

4. **CPU使用率过高**：
   - 减少工作线程数量
   - 优化耗时操作
   - 增加服务器资源

## 许可证

MIT
